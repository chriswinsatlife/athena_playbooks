---
/**
 * Notifications - Display notification banners in platform-specific styles
 * 
 * Usage:
 *   Inline:
 *     <Notifications 
 *       style="macos"
 *       notifications={[
 *         { app: "Messages", title: "Mom", body: "Don't forget dinner tonight!", time: "now" },
 *         { app: "Slack", title: "#general", body: "New message from @alex", time: "2m ago" }
 *       ]}
 *     />
 * 
 *   From file (JSON or YAML):
 *     <Notifications style="ios" src="/data/notifications.json" />
 * 
 *   Mode control:
 *     <Notifications mode="light" ... />  <!-- Force light -->
 *     <Notifications mode="dark" ... />   <!-- Force dark -->
 *     <Notifications mode="auto" ... />   <!-- Use prefers-color-scheme (default) -->
 * 
 *   With background (for liquid glass effect):
 *     <Notifications style="liquidglass" background="/images/wallpaper.jpg" ... />
 *     <Notifications style="liquidglass" background="#1a1a2e" ... />
 * 
 * Notification format:
 *   - app: string - required, app name (used for icon if no icon provided)
 *   - title: string - required, notification title
 *   - body?: string - optional, notification body text
 *   - time?: string - optional, timestamp (e.g. "now", "2m ago", "10:30 AM")
 *   - icon?: string - optional, URL to app icon image
 * 
 * Styles: macos | ios | android | windows | liquidglass
 */

import { parse as parseYAML } from 'yaml';

export interface Notification {
  app: string;
  title: string;
  body?: string;
  time?: string;
  icon?: string;
}

export interface Props {
  style?: 'macos' | 'ios' | 'android' | 'windows' | 'liquidglass';
  notifications?: Notification[];
  src?: string;
  /** Force light or dark mode; 'auto' uses prefers-color-scheme */
  mode?: 'light' | 'dark' | 'auto';
  /** Background image URL or color for liquid glass effect */
  background?: string;
}

const { style = 'macos', notifications: inlineNotifications, src, mode = 'auto', background } = Astro.props;

let notifications: Notification[] = inlineNotifications || [];

// Load from file if src provided
if (src && !inlineNotifications) {
  try {
    const response = await fetch(new URL(src, Astro.url));
    const text = await response.text();
    
    if (src.endsWith('.yaml') || src.endsWith('.yml')) {
      notifications = parseYAML(text);
    } else {
      notifications = JSON.parse(text);
    }
  } catch (e) {
    console.error(`Failed to load notifications from ${src}:`, e);
  }
}

// Compute mode class
const modeClass = mode === 'auto' ? '' : `mode-${mode}`;

// Determine if background is a color/gradient or image URL
const isBackgroundColor = background?.startsWith('#') || background?.startsWith('rgb') || background?.startsWith('hsl') || background?.startsWith('linear') || background?.startsWith('radial') || background?.startsWith('conic');
const backgroundStyle = background 
  ? isBackgroundColor 
    ? `background: ${background};` 
    : `background-image: url('${background}'); background-size: cover; background-position: center;`
  : '';

// Generate a placeholder icon based on app name
function getPlaceholderIcon(app: string): string {
  const colors: Record<string, string> = {
    'Messages': '#34c759',
    'Mail': '#007aff',
    'Slack': '#4a154b',
    'Calendar': '#ff3b30',
    'Reminders': '#ff9500',
    'Notes': '#ffcc00',
    'Twitter': '#000000',
    'X': '#000000',
    'Settings': '#8e8e93',
    'Safari': '#007aff',
    'FaceTime': '#34c759',
    'Photos': '#ff2d55',
    'Music': '#fc3c44',
    'News': '#fc3c44',
    'Accessibility': '#007aff',
  };
  return colors[app] || '#8e8e93';
}

function getAppInitial(app: string): string {
  // Handle special cases
  if (app === 'X') return 'X';
  return app.charAt(0).toUpperCase();
}
---

{style === 'liquidglass' ? (
  <div class={`notifications-wrapper${modeClass ? ` ${modeClass}` : ''}`} style={backgroundStyle}>
    <div class="notifications-container notifications-liquidglass">
      {notifications.map((notif) => (
        <div class="notification">
          <div class="notification-specular"></div>
          <div class="notification-inner">
            <div class="notification-icon">
              {notif.icon ? (
                <img src={notif.icon} alt={notif.app} />
              ) : (
                <div class="notification-icon-placeholder" style={`background-color: ${getPlaceholderIcon(notif.app)}`}>
                  <span>{getAppInitial(notif.app)}</span>
                </div>
              )}
            </div>
            <div class="notification-content">
              <div class="notification-header">
                <span class="notification-title">{notif.title}</span>
                {notif.time && <span class="notification-time">{notif.time}</span>}
              </div>
              {notif.body && <p class="notification-body">{notif.body}</p>}
            </div>
          </div>
        </div>
      ))}
    </div>
  </div>
) : (
  <div class={`notifications-container notifications-${style}${modeClass ? ` ${modeClass}` : ''}`}>
    {notifications.map((notif) => (
      <div class="notification">
        <div class="notification-icon">
          {notif.icon ? (
            <img src={notif.icon} alt={notif.app} />
          ) : (
            <div class="notification-icon-placeholder" style={`background-color: ${getPlaceholderIcon(notif.app)}`}>
              <span>{getAppInitial(notif.app)}</span>
            </div>
          )}
        </div>
        <div class="notification-content">
          <div class="notification-header">
            <span class="notification-title">{notif.title}</span>
            {notif.time && <span class="notification-time">{notif.time}</span>}
          </div>
          {notif.body && <p class="notification-body">{notif.body}</p>}
        </div>
      </div>
    ))}
  </div>
)}

<style>
  /* Base styles */
  .notifications-container {
    display: flex;
    flex-direction: column;
    gap: 0.625rem;
    max-width: 22rem;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  }

  .notification {
    display: flex;
    gap: 0.75rem;
    padding: 0.875rem 1rem;
    border-radius: 1rem;
    align-items: flex-start;
  }

  .notification-icon {
    flex-shrink: 0;
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 0.5rem;
    overflow: hidden;
  }

  .notification-icon img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .notification-icon-placeholder {
    width: 100%;
    height: 100%;
    border-radius: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-weight: 600;
    font-size: 1.125rem;
  }

  .notification-content {
    flex: 1;
    min-width: 0;
  }

  .notification-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    gap: 0.5rem;
  }

  .notification-title {
    font-weight: 600;
    font-size: 0.9375rem;
    line-height: 1.3;
  }

  .notification-time {
    font-size: 0.8125rem;
    flex-shrink: 0;
  }

  .notification-body {
    margin: 0.125rem 0 0;
    font-size: 0.9375rem;
    line-height: 1.4;
  }

  /* ========================================
     macOS Style (Tahoe/Sequoia)
     ======================================== */
  .notifications-macos .notification {
    background: rgba(30, 30, 30, 0.85);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .notifications-macos .notification-title {
    color: #fff;
  }

  .notifications-macos .notification-time {
    color: rgba(255, 255, 255, 0.5);
  }

  .notifications-macos .notification-body {
    color: rgba(255, 255, 255, 0.8);
  }

  .notifications-macos .notification-icon-placeholder {
    border-radius: 0.625rem;
  }

  /* ========================================
     iOS Style
     ======================================== */
  .notifications-ios .notification {
    background: rgba(30, 30, 30, 0.8);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 1.25rem;
  }

  .notifications-ios .notification-icon {
    width: 2.25rem;
    height: 2.25rem;
  }

  .notifications-ios .notification-icon img,
  .notifications-ios .notification-icon-placeholder {
    border-radius: 0.5rem;
  }

  .notifications-ios .notification-title {
    color: #fff;
    font-size: 0.875rem;
  }

  .notifications-ios .notification-time {
    color: rgba(255, 255, 255, 0.4);
    font-size: 0.75rem;
  }

  .notifications-ios .notification-body {
    color: rgba(255, 255, 255, 0.75);
    font-size: 0.875rem;
  }

  /* ========================================
     Android Style (Material You)
     ======================================== */
  .notifications-android .notification {
    background: #1e1e1e;
    border-radius: 1.5rem;
    padding: 1rem 1.25rem;
  }

  .notifications-android .notification-icon {
    width: 1.5rem;
    height: 1.5rem;
  }

  .notifications-android .notification-icon img,
  .notifications-android .notification-icon-placeholder {
    border-radius: 50%;
  }

  .notifications-android .notification-icon-placeholder {
    font-size: 0.75rem;
  }

  .notifications-android .notification-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 0;
  }

  .notifications-android .notification-title {
    color: #e3e3e3;
    font-size: 0.875rem;
    font-weight: 500;
  }

  .notifications-android .notification-time {
    color: #9e9e9e;
    font-size: 0.75rem;
    order: -1;
    margin-bottom: 0.125rem;
  }

  .notifications-android .notification-body {
    color: #b3b3b3;
    font-size: 0.875rem;
  }

  /* ========================================
     Windows Style (Windows 11)
     ======================================== */
  .notifications-windows .notification {
    background: #2d2d2d;
    border-radius: 0.5rem;
    padding: 0.75rem 1rem;
    border: 1px solid #3d3d3d;
  }

  .notifications-windows .notification-icon {
    width: 2rem;
    height: 2rem;
  }

  .notifications-windows .notification-icon img,
  .notifications-windows .notification-icon-placeholder {
    border-radius: 0.25rem;
  }

  .notifications-windows .notification-icon-placeholder {
    font-size: 0.875rem;
  }

  .notifications-windows .notification-title {
    color: #fff;
    font-size: 0.875rem;
  }

  .notifications-windows .notification-time {
    color: #999;
    font-size: 0.75rem;
  }

  .notifications-windows .notification-body {
    color: #ccc;
    font-size: 0.8125rem;
  }

  /* ========================================
     Liquid Glass Style (macOS 26 / iOS 26)
     ======================================== */
  .notifications-wrapper {
    padding: 2rem;
    border-radius: 1rem;
    position: relative;
  }

  .notifications-liquidglass {
    position: relative;
  }

  .notifications-liquidglass .notification {
    position: relative;
    border-radius: 1.25rem;
    overflow: hidden;
  }

  /* Single unified glass layer - no separate specular */
  .notifications-liquidglass .notification-inner {
    position: relative;
    display: flex;
    gap: 0.75rem;
    padding: 0.875rem 1rem;
    align-items: flex-start;
    /* Glass material with blur */
    background: rgba(255, 255, 255, 0.12);
    backdrop-filter: blur(40px) saturate(1.5);
    -webkit-backdrop-filter: blur(40px) saturate(1.5);
    border-radius: 1.25rem;
    /* Single subtle top highlight for convex look */
    box-shadow: 
      inset 0 1px 0 rgba(255, 255, 255, 0.25),
      0 0 0 1px rgba(255, 255, 255, 0.1);
  }

  /* Hide the separate specular layer - it creates ugly double borders */
  .notifications-liquidglass .notification-specular {
    display: none;
  }

  .notifications-liquidglass .notification-icon {
    flex-shrink: 0;
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 0.625rem;
    overflow: hidden;
    background: rgba(0, 0, 0, 0.2);
  }

  .notifications-liquidglass .notification-icon img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .notifications-liquidglass .notification-icon-placeholder {
    width: 100%;
    height: 100%;
    border-radius: 0.625rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-weight: 600;
    font-size: 1.125rem;
  }

  .notifications-liquidglass .notification-content {
    flex: 1;
    min-width: 0;
  }

  .notifications-liquidglass .notification-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    gap: 0.5rem;
  }

  .notifications-liquidglass .notification-title {
    color: #fff;
    font-weight: 600;
    font-size: 0.9375rem;
    line-height: 1.3;
  }

  .notifications-liquidglass .notification-time {
    color: rgba(255, 255, 255, 0.5);
    font-size: 0.8125rem;
    flex-shrink: 0;
  }

  .notifications-liquidglass .notification-body {
    margin: 0.125rem 0 0;
    color: rgba(255, 255, 255, 0.85);
    font-size: 0.9375rem;
    line-height: 1.4;
  }

  /* Light mode liquid glass */
  .notifications-wrapper.mode-light .notification-inner {
    background: rgba(255, 255, 255, 0.5);
    box-shadow: 
      inset 0 1px 0 rgba(255, 255, 255, 0.6),
      0 0 0 1px rgba(255, 255, 255, 0.3);
  }

  .notifications-wrapper.mode-light .notification-title {
    color: #1d1d1f;
  }

  .notifications-wrapper.mode-light .notification-time {
    color: rgba(0, 0, 0, 0.4);
  }

  .notifications-wrapper.mode-light .notification-body {
    color: rgba(0, 0, 0, 0.7);
  }

  .notifications-wrapper.mode-light .notification-icon {
    background: rgba(255, 255, 255, 0.3);
  }

  /* ========================================
     Light Mode Styles
     ======================================== */
  .notifications-container.mode-light.notifications-macos .notification,
  .notifications-container.mode-light.notifications-ios .notification {
    background: rgba(255, 255, 255, 0.85);
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  .notifications-container.mode-light.notifications-macos .notification-title,
  .notifications-container.mode-light.notifications-ios .notification-title {
    color: #1d1d1f;
  }

  .notifications-container.mode-light.notifications-macos .notification-time,
  .notifications-container.mode-light.notifications-ios .notification-time {
    color: rgba(0, 0, 0, 0.4);
  }

  .notifications-container.mode-light.notifications-macos .notification-body,
  .notifications-container.mode-light.notifications-ios .notification-body {
    color: rgba(0, 0, 0, 0.7);
  }

  .notifications-container.mode-light.notifications-android .notification {
    background: #f5f5f5;
  }

  .notifications-container.mode-light.notifications-android .notification-title {
    color: #1f1f1f;
  }

  .notifications-container.mode-light.notifications-android .notification-time {
    color: #757575;
  }

  .notifications-container.mode-light.notifications-android .notification-body {
    color: #424242;
  }

  .notifications-container.mode-light.notifications-windows .notification {
    background: #f3f3f3;
    border-color: #e0e0e0;
  }

  .notifications-container.mode-light.notifications-windows .notification-title {
    color: #1a1a1a;
  }

  .notifications-container.mode-light.notifications-windows .notification-time {
    color: #666;
  }

  .notifications-container.mode-light.notifications-windows .notification-body {
    color: #444;
  }

  /* ========================================
     Auto Mode (prefers-color-scheme)
     ======================================== */
  @media (prefers-color-scheme: light) {
    .notifications-container:not(.mode-dark).notifications-macos .notification,
    .notifications-container:not(.mode-dark).notifications-ios .notification {
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .notifications-container:not(.mode-dark).notifications-macos .notification-title,
    .notifications-container:not(.mode-dark).notifications-ios .notification-title {
      color: #1d1d1f;
    }

    .notifications-container:not(.mode-dark).notifications-macos .notification-time,
    .notifications-container:not(.mode-dark).notifications-ios .notification-time {
      color: rgba(0, 0, 0, 0.4);
    }

    .notifications-container:not(.mode-dark).notifications-macos .notification-body,
    .notifications-container:not(.mode-dark).notifications-ios .notification-body {
      color: rgba(0, 0, 0, 0.7);
    }

    .notifications-container:not(.mode-dark).notifications-android .notification {
      background: #f5f5f5;
    }

    .notifications-container:not(.mode-dark).notifications-android .notification-title {
      color: #1f1f1f;
    }

    .notifications-container:not(.mode-dark).notifications-android .notification-time {
      color: #757575;
    }

    .notifications-container:not(.mode-dark).notifications-android .notification-body {
      color: #424242;
    }

    .notifications-container:not(.mode-dark).notifications-windows .notification {
      background: #f3f3f3;
      border-color: #e0e0e0;
    }

    .notifications-container:not(.mode-dark).notifications-windows .notification-title {
      color: #1a1a1a;
    }

    .notifications-container:not(.mode-dark).notifications-windows .notification-time {
      color: #666;
    }

    .notifications-container:not(.mode-dark).notifications-windows .notification-body {
      color: #444;
    }
  }
</style>
