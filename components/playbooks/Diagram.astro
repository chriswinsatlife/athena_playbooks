---
type Props = {
  src: string;
  alt: string;
  title?: string;
  caption?: string;
  download?: boolean;
  downloadSrc?: string;
};

const {
  src,
  alt,
  title,
  caption,
  download = true,
  downloadSrc,
} = Astro.props;

if (!src || !src.startsWith('/')) {
  throw new Error(`Diagram: src must be a site-root path like /playbooks/... (got: ${src})`);
}
const resolvedDownload = downloadSrc ?? src.replace(/\.svg$/i, '.png');
---

<figure class="playbook-diagram">
  {title && <figcaption class="playbook-diagram__title">{title}</figcaption>}
  <div class="playbook-diagram__frame">
    <a class="playbook-diagram__open" href={src} target="_blank" rel="noreferrer" aria-label={`Open diagram: ${alt}`}>
      <img class="playbook-diagram__img" src={src} alt={alt} loading="lazy" />
    </a>
  </div>
  {(caption || download) && (
    <figcaption class="playbook-diagram__caption">
      {caption && <span>{caption}</span>}
      {download && (
        <a class="playbook-diagram__download" href={resolvedDownload} download>
          Download PNG
        </a>
      )}
    </figcaption>
  )}
  <div class="playbook-diagram__hint">Download for full-size view</div>
</figure>

<style>
  @font-face{
    font-family: 'Figtree';
    src: url('/fonts/Figtree[wght].ttf') format('truetype');
    font-weight: 300 900;
    font-style: normal;
    font-display: swap;
  }
  @font-face{
    font-family: 'Figtree';
    src: url('/fonts/Figtree-Italic[wght].ttf') format('truetype');
    font-weight: 300 900;
    font-style: italic;
    font-display: swap;
  }

  .playbook-diagram{
    margin: 1.25rem 0;
  }
  .playbook-diagram__title{
    font-weight: 650;
    margin: 0 0 0.5rem 0;
  }
  .playbook-diagram__frame{
    border: 1px solid rgba(0,0,0,0.08);
    border-radius: 12px;
    background: #fff;
    overflow: auto;
    -webkit-overflow-scrolling: touch;
    --diagram-font-family: 'Figtree', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Arial, sans-serif;
    --diagram-node-fill: #f6fbf7;
    --diagram-node-stroke: #05240C;
    --diagram-node-stroke-width: 2;
    --diagram-edge-stroke: rgba(0,0,0,0.55);
    --diagram-edge-stroke-width: 1.6;
    --diagram-label-fill: rgba(0,0,0,0.86);
  }
  .playbook-diagram__img{
    display: block;
    width: auto;
    height: auto;
    max-width: none;
    min-width: 100%;
  }
  .playbook-diagram__open{ display: block; }
  .playbook-diagram__caption{
    display: flex;
    gap: 0.75rem;
    justify-content: space-between;
    align-items: baseline;
    margin: 0.5rem 0 0 0;
    color: rgba(0,0,0,0.72);
    font-size: 0.95rem;
  }
  .playbook-diagram__download{
    white-space: nowrap;
    color: #fff;
    background: #05240C;
    border: 1px solid rgba(0,0,0,0.14);
    border-radius: 999px;
    padding: 0.5rem 0.85rem;
    text-decoration: none;
  }
  .playbook-diagram__download:hover{
    background: #062812;
  }
  .playbook-diagram__hint{
    display: none;
    margin-top: 0.35rem;
    font-size: 0.85rem;
    color: rgba(0,0,0,0.55);
  }
  @media (max-width: 640px){
    .playbook-diagram__caption{ flex-direction: column; align-items: flex-start; }
    .playbook-diagram__download{ width: 100%; text-align: center; }
    .playbook-diagram__hint{ display: block; }
    .playbook-diagram__frame{ overflow: hidden; }
    .playbook-diagram__img{ width: 100%; max-width: 100%; min-width: 0; }
  }
</style>
